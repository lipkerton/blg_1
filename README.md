# технологии #
FastAPI, PostgreSQL, Alembic, Pydantic, JWT, Pytest, Docker

# о чем это #
Я хотел сделать небольшой проект на FastAPI с аутентификацией по токену JWT. Сейчас реализован интерфейс для коннекта с PostgreSQL, API для создания и получения постов, написаны соответствующие модели + написаны модели, которые связаны с пользователями на ресурсе. Для логина пока используется Basic Auth, далее на защищенные разделы сервиса доступ обеспечивается по JWT токену. Так же есть тесты, которые я писал на Pytest.

# как запустить #

## заполнить файл .env ##
Перед любой попыткой запуска нужно заполнить `.env` файл по шаблону:
```
POSTGRES_DB_HOST="postgres_blg_1"  # для запуска в контейнере
# POSTGRES_DB_HOST="127.0.0.1"  # для запуска локально
POSTGRES_DB_NAME="<имя БД>"
POSTGRES_DB_USER="<имя пользователя>"
POSTGRES_DB_PASS="<пароль пользователя>"
POSTGRES_DB_PORT=<порт на подключение к БД>  # порт на котором БД слушает запросы
POSTGRES_DB_PORT_HOST=<порт на подключение с хоста>  # порт контейнера для подключений к БД внутри него

JWT_SECRET_KEY="<дополнительный секретный ключ для JWT токена>"
JWT_ALGORITHM="<алгоритм шифрования для JWT токена>"
```

## просто, банально - локально ##
Сначала нужно сделать виртуальное окружение и установить зависимости:
```
python -m venv .venv
source .venv/bin/activate
python -m pip install -r requirements.txt
```
Затем применить миграции:
```
alembic upgrade head
```
Теперь нужно создать `.env` файл и внести туда необходимые данные (список необходимых коснтант можно найти в `app/config.py`.
Запуск сервера разработки:
```
uvicorn main:app
```

## docker? ##
Запустить контейнеры:
```
docker compose up
```
Внутри контейнера применить миграции:
```
docker exec blg_1-blg_1-1 alembic upgrade head
```

# как написать запросы? #

Запросы можно отправлять и через Swagger - он доступен по ссылке `http://127.0.0.1:8000/docs`. Я использую `curl` только ради понта.

Чтобы создать юзера:
```
curl -X POST -H \
"Content-Type: application/json" -d \
'{"username": "peter_2", "password": "1234"}' \
http://127.0.0.1:8000/user
```
Чтобы получить токен (залогиниться):
```
curl -X POST \
--user "peter_2:1234" \
http://127.0.0.1:8000/login
```
Перед тем как перейти к следующему шагу лучше сначала глянуть `id` вашего пользователя:
```
curl -X GET http://127.0.0.1:8000/user
```
A проверить работу токена можно с помощью POST запроса для создания поста:
```
curl -X POST \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <токен, который получили ранее>" \
-d '{"title": "my first post", "content": "prikol", "user_id": 2}' \
http://127.0.0.1:8000/p
```
Ну и хорошо было бы глянуть сам пост:
```
curl -X GET http://127.0.0.1:8000/p
```

# как тестировать? #
Тесты в проекте живут по адресу `py_tests/`. Они написаны на `pytest` и используют интеграцию `pytest` и `asyncio`.
Чтобы запустить тесты нужно ввести команду:
```
pytest py_tests/
```
Чтобы запустить тесты внутри контейнера:
```
docker exec blg_1-blg_1-1 pytest py_tests/
```

Описание тестов:
- `test_db` - создаем движок, сессию и тестируем подключение к БД.
- `test_user` - создаем пользователя, проверяем его наличие в БД, логиним, делаем от его имени запросы к эндпоинтам для получения списка пользователей + конкретного пользователя, а после всего этого удаляем пользователя и проверяем удаление в БД.
- `test_post` - создаем пользователя, логиним пользователя, создаем пост, проверяем наличие поста БД, удаляем пост и удаляем пользователя.
