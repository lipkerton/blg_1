# технологии #
FastAPI, PostgreSQL, Alembic, Pydantic, JWT

# о чем это #
Я хотел сделать небольшой проект на FastAPI с аутентификацией по токену JWT. Сейчас реализован интерфейс для коннекта с PostgreSQL, API для создания и получения постов, написаны соответствующие модели + написаны модели, которые связаны с пользователями на ресурсе. Для логина пока используется Basic Auth, далее на защищенные разделы сервиса доступ обеспечивается по JWT токену.

# как запустить #
Сначала нужно сделать виртуальное окружение и установить зависимости:
```
python -m venv .venv
source .venv/bin/activate
python -m pip install -r requirements.txt
```
Затем сделать миграционные файлы и применить миграции:
```
alembic revision --autogenerate -m "Init migration"
alembic upgrade head
```
Теперь нужно создать `.env` файл и внести туда необходимые данные (список необходимых коснтант можно найти в `app/config.py`.
Запуск сервера разработки:
```
uvicorn main:app
```
# как написать запросы? #

>[!important] Запросы можно отправлять и через Swagger - он доступен по ссылке `http://127.0.0.1:8000/docs`. Я использую `curl` только ради понта.

Чтобы создать юзера:
```
curl -X POST -H \
"Content-Type: application/json" -d \
'{"username": "peter_2", "password": "1234"}' \
http://127.0.0.1:8000/user
```
Чтобы получить токен (залогиниться):
```
curl -X POST \
--user "peter_2:1234" \
http://127.0.0.1:8000/login
```
Перед тем как перейти к следующему шагу лучше сначала глянуть `id` вашего пользователя:
```
curl -X GET http://127.0.0.1:8000/user
```
A проверить работу токена можно с помощью POST запроса для создания поста:
```
curl -X POST \
-H "Content-Type: application/json" \
-H "Authorization: Bearer <токен, который получили ранее>" \
-d '{"title": "my first post", "content": "prikol", "user_id": 2}' \
http://127.0.0.1:8000/p
```
Ну и хорошо было бы глянуть сам пост:
```
curl -X GET http://127.0.0.1:8000/p
```
# как тестировать? #
Тесты в проекте живут по адресу `py_tests/`. Они написаны на `pytest` и используют интеграцию `pytest` и `asyncio`. Чтобы запустить тесты нужно ввести команду:
```
pytest py_tests/
```
Описание тестов:
- `test_db` - создаем движок, сессию и тестируем подключение к БД.
- `test_user` - создаем пользователя, проверяем его наличие в БД, логиним, делаем от его имени запросы к эндпоинтам для получения списка пользователей + конкретного пользователя, а после всего этого удаляем пользователя и проверяем удаление в БД.
